{"version":3,"sources":["../src/PDFJSController.js"],"names":["global","PDFJS","require","TextLayerBuilder","domify","domMap","defaultInnerHTML","module","exports","PDFJSController","constructor","container","innerHTML","pageNumber","pdfjsDistDir","pdfContainer","pdfjsDistDirWithoutSuffix","replace","workerSrc","cMapUrl","cMapPacked","pdfDoc","pageNum","promiseQueue","Promise","resolve","html","dom","mapping","progressBar","canvas","textLayer","annotationLayer","loading","domMapObject","appendChild","canvasContext","getContext","fitItSize","Events","loadDocument","url","hideLoadingIcon","style","display","addEventListener","before_pdf_rendering","getDocument","then","pdfDoc_","_queueRenderPage","removeEventListener","renderPage","containerRect","getBoundingClientRect","width","height","_cleanup","range","document","createRange","selectNodeContents","deleteContents","beforeEvent","CustomEvent","detail","dispatchEvent","getPage","page","viewport","getViewport","renderContext","renderPromise","render","promise","textLayerPromise","getTextContent","textContent","textLayerBuilder","textLayerDiv","pageIndex","setTextContent","all","result","_setupAnnotations","_updateProgress","afterEvent","after_pdf_rendering","prevPage","nextPage","numPages","numSlides","position","percent","toString","annotationArea","getAnnotations","annotationsData","cViewport","clone","dontFlip","i","length","data","hasHtml","element","AnnotationUtils","getHtmlElement","rect","view","Util","normalizeRect","left","top","transform","transformStr","join","CustomStyle","setProp","transformOriginStr","subtype"],"mappings":"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","file":"PDFJSController.js","sourcesContent":["// LICENSE : MIT\n'use strict';\nglobal.PDFJS = global.PDFJS || {};\n//const stringToWorkerSrc = require(\"./string-to-worker-src\");\n//const workerCode = require(\"fs\").readFileSync(__dirname + '/../node_modules/pdfjs-dist/build/pdf.worker.js', \"utf-8\");\nrequire('pdfjs-dist/build/pdf.combined.js');\nrequire('pdfjs-dist/web/compatibility.js');\nrequire(\"custom-event-polyfill\");\nconst TextLayerBuilder = require('./pdf.js-contrib/text_layer_builder').TextLayerBuilder;\nconst domify = require('domify');\nconst domMap = require('./dom-map');\nconst defaultInnerHTML = `<div class=\"pdf-slide-progress\">\n    <div class=\"pdf-slide-progress-bar\"></div>\n</div>\n<div class=\"pdf-loading\"></div>\n<canvas class=\"pdf-canvas\"></canvas>\n<div class=\"pdf-textLayer\"></div>\n<div class=\"pdf-annotationLayer\"></div>`;\nmodule.exports = class PDFJSController {\n    constructor({container, innerHTML, pageNumber, pdfjsDistDir}) {\n        this.pdfContainer = container;\n        if (pdfjsDistDir) {\n            const pdfjsDistDirWithoutSuffix = pdfjsDistDir.replace(/\\/$/, '');\n            global.PDFJS.workerSrc = `${ pdfjsDistDirWithoutSuffix }/build/pdf.worker.js`;\n            global.PDFJS.cMapUrl = `${ pdfjsDistDirWithoutSuffix }/cmaps/`;\n            global.PDFJS.cMapPacked = true;\n        }\n        this.pdfDoc = null;\n        this.pageNum = pageNumber || 1;\n        this.promiseQueue = Promise.resolve();\n        this.pdfContainer = container;\n        const html = innerHTML || defaultInnerHTML;\n        const dom = domify(html);\n        /*\n         * @type {Object.<string, Node>}\n         */\n        const mapping = {\n            progressBar: '.pdf-slide-progress-bar',\n            canvas: '.pdf-canvas',\n            textLayer: '.pdf-textLayer',\n            annotationLayer: '.pdf-annotationLayer',\n            loading: '.pdf-loading'\n        };\n        this.domMapObject = domMap(dom, mapping);\n        container.appendChild(dom);\n        this.canvasContext = this.domMapObject.canvas.getContext('2d');\n        this.fitItSize();\n    }\n\n    static get Events() {\n        return {\n            'before_pdf_rendering': 'before-pdf-rendering',\n            'after_pdf_rendering': 'after_pdf_rendering'\n        };\n    }\n\n    loadDocument(url) {\n        // load complete\n        let loading = this.domMapObject.loading;\n        function hideLoadingIcon() {\n            loading.style.display = 'none';\n        }\n\n        this.pdfContainer.addEventListener(this.constructor.Events.before_pdf_rendering, hideLoadingIcon);\n        return PDFJS.getDocument(url).then(pdfDoc_ => {\n            this.pdfDoc = pdfDoc_;\n            return this._queueRenderPage(this.pageNum);\n        }).then(() => {\n            this.pdfContainer.removeEventListener(this.constructor.Events.before_pdf_rendering, hideLoadingIcon);\n        });\n    }\n\n    _queueRenderPage(pageNum) {\n        if (this.pdfDoc == null) {\n            return this.promiseQueue;\n        }\n        this.promiseQueue = this.promiseQueue.then(() => {\n            return this.renderPage(pageNum);\n        });\n        return this.promiseQueue;\n    }\n\n    fitItSize() {\n        return new Promise((resolve) => {\n            const containerRect = this.pdfContainer.getBoundingClientRect();\n            this.domMapObject.canvas.width = containerRect.width;\n            this.domMapObject.canvas.height = containerRect.height;\n            resolve(containerRect);\n        }).then(() => {\n            return this._queueRenderPage(this.pageNum);\n        });\n    }\n\n    _cleanup() {\n        const range = document.createRange();\n        const domMapObject = this.domMapObject;\n        range.selectNodeContents(domMapObject.textLayer);\n        range.deleteContents();\n        range.selectNodeContents(domMapObject.annotationLayer);\n        range.deleteContents();\n    }\n\n    renderPage(pageNum) {\n        const beforeEvent = new CustomEvent(this.constructor.Events.before_pdf_rendering, {detail: this});\n        this.pdfContainer.dispatchEvent(beforeEvent);\n        // Using promise to fetch the page\n        return this.pdfDoc.getPage(pageNum).then(page => {\n            this._cleanup();\n            const domMapObject = this.domMapObject;\n            const viewport = page.getViewport(domMapObject.canvas.width / page.getViewport(1).width);\n            domMapObject.canvas.height = viewport.height;\n            domMapObject.canvas.width = viewport.width;\n            domMapObject.textLayer.style.width = domMapObject.canvas.style.width;\n            domMapObject.textLayer.style.height = domMapObject.canvas.style.height;\n            // Render PDF page into canvas context\n            const renderContext = {\n                canvasContext: this.canvasContext,\n                viewport: viewport\n            };\n            const renderPromise = page.render(renderContext).promise;\n            const textLayerPromise = page.getTextContent().then(textContent => {\n                const textLayerBuilder = new TextLayerBuilder({\n                    textLayerDiv: domMapObject.textLayer,\n                    viewport: viewport,\n                    pageIndex: 0\n                });\n                textLayerBuilder.setTextContent(textContent);\n                textLayerBuilder.render();\n            });\n            return Promise.all([\n                renderPromise,\n                textLayerPromise\n            ]).then(result => {\n                this._setupAnnotations(page, viewport, domMapObject.annotationLayer);\n            });\n        }).then(() => {\n            this._updateProgress(pageNum);\n            const afterEvent = new CustomEvent(this.constructor.Events.after_pdf_rendering, {detail: this});\n            this.pdfContainer.dispatchEvent(afterEvent);\n        });\n    }\n\n    prevPage() {\n        if (this.pageNum <= 1) {\n            return;\n        }\n        this.pageNum--;\n        return this._queueRenderPage(this.pageNum);\n    }\n\n    nextPage() {\n        if (this.pageNum >= this.pdfDoc.numPages) {\n            return;\n        }\n        this.pageNum++;\n        return this._queueRenderPage(this.pageNum);\n    }\n\n    _updateProgress(pageNum) {\n        const progressBar = this.domMapObject.progressBar;\n        if (progressBar !== null) {\n            const numSlides = this.pdfDoc.numPages;\n            let position = pageNum - 1;\n            const percent = numSlides === 1 ? 100 : 100 * position / (numSlides - 1);\n            progressBar.style.width = `${ percent.toString() }%`;\n        }\n    }\n\n    _setupAnnotations(page, viewport, annotationArea) {\n        return page.getAnnotations().then(annotationsData => {\n            const cViewport = viewport.clone({dontFlip: true});\n            for (let i = 0; i < annotationsData.length; i++) {\n                const data = annotationsData[i];\n                if (!data || !data.hasHtml) {\n                    continue;\n                }\n                const element = PDFJS.AnnotationUtils.getHtmlElement(data);\n                let rect = data.rect;\n                const view = page.view;\n                rect = PDFJS.Util.normalizeRect([\n                    rect[0],\n                    view[3] - rect[1] + view[1],\n                    rect[2],\n                    view[3] - rect[3] + view[1]\n                ]);\n                element.style.left = `${ rect[0] }px`;\n                element.style.top = `${ rect[1] }px`;\n                element.style.position = 'absolute';\n                const transform = cViewport.transform;\n                const transformStr = `matrix(${ transform.join(',') })`;\n                PDFJS.CustomStyle.setProp('transform', element, transformStr);\n                const transformOriginStr = `${ -rect[0] }px ${ -rect[1] }px`;\n                PDFJS.CustomStyle.setProp('transformOrigin', element, transformOriginStr);\n                if (data.subtype === 'Link' && !data.url) {\n                    // In this example,  we do not handle the `Link` annotation without url.\n                    // If you want to handle these links, see `web/page_view.js`.\n                    continue;\n                }\n                annotationArea.appendChild(element);\n            }\n        });\n    }\n};"]}