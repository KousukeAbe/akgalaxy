{"version":3,"sources":["../../src/pdf.js-contrib/text_layer_builder.js"],"names":["TextLayerBuilder","TextLayerBuilderClosure","options","textLayerDiv","renderingDone","divContentDone","pageIdx","pageIndex","pageNumber","matches","viewport","textDivs","findController","textLayerRenderTask","_bindMouse","prototype","_finishRendering","TextLayerBuilder_finishRendering","endOfContent","document","createElement","className","appendChild","event","createEvent","initCustomEvent","dispatchEvent","render","TextLayerBuilder_render","timeout","cancel","textLayerFrag","createDocumentFragment","PDFJS","renderTextLayer","textContent","container","promise","then","updateMatches","bind","reason","setTextContent","TextLayerBuilder_setTextContent","convertMatches","TextLayerBuilder_convertMatches","i","iIndex","bidiTexts","items","end","length","queryLen","state","query","ret","m","len","matchIdx","str","console","error","match","begin","divIdx","offset","push","renderMatches","TextLayerBuilder_renderMatches","prevEnd","isSelectedPage","selected","selectedMatchIdx","highlightAll","infinity","undefined","beginText","appendTextToDiv","fromOffset","toOffset","div","content","substring","node","createTextNode","span","i0","i1","isSelected","highlightSuffix","updateMatchPosition","n0","n1","TextLayerBuilder_updateMatches","clearedUntilDivIdx","Math","max","n","active","pageMatches","TextLayerBuilder_bindMouse","addEventListener","e","querySelector","adjustTop","target","window","getComputedStyle","getPropertyValue","divBounds","getBoundingClientRect","r","pageY","top","height","style","toFixed","classList","add","remove","DefaultTextLayerFactory","createTextLayerBuilder","module","exports"],"mappings":"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","file":"text_layer_builder.js","sourcesContent":["/* Copyright 2012 Mozilla Foundation\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/* globals PDFJS */\n\n'use strict';\n\n/**\n * @typedef {Object} TextLayerBuilderOptions\n * @property {HTMLDivElement} textLayerDiv - The text layer container.\n * @property {number} pageIndex - The page index.\n * @property {PageViewport} viewport - The viewport of the text layer.\n * @property {PDFFindController} findController\n */\n\n/**\n * TextLayerBuilder provides text-selection functionality for the PDF.\n * It does this by creating overlay divs over the PDF text. These divs\n * contain text that matches the PDF text they are overlaying. This object\n * also provides a way to highlight text that is being searched for.\n * @class\n */\nvar TextLayerBuilder = (function TextLayerBuilderClosure() {\n  function TextLayerBuilder(options) {\n    this.textLayerDiv = options.textLayerDiv;\n    this.renderingDone = false;\n    this.divContentDone = false;\n    this.pageIdx = options.pageIndex;\n    this.pageNumber = this.pageIdx + 1;\n    this.matches = [];\n    this.viewport = options.viewport;\n    this.textDivs = [];\n    this.findController = options.findController || null;\n    this.textLayerRenderTask = null;\n    this._bindMouse();\n  }\n\n  TextLayerBuilder.prototype = {\n    _finishRendering: function TextLayerBuilder_finishRendering() {\n      this.renderingDone = true;\n\n      var endOfContent = document.createElement('div');\n      endOfContent.className = 'endOfContent';\n      this.textLayerDiv.appendChild(endOfContent);\n\n      var event = document.createEvent('CustomEvent');\n      event.initCustomEvent('textlayerrendered', true, true, {\n        pageNumber: this.pageNumber\n      });\n      this.textLayerDiv.dispatchEvent(event);\n    },\n\n    /**\n     * Renders the text layer.\n     * @param {number} timeout (optional) if specified, the rendering waits\n     *   for specified amount of ms.\n     */\n    render: function TextLayerBuilder_render(timeout) {\n      if (!this.divContentDone || this.renderingDone) {\n        return;\n      }\n\n      if (this.textLayerRenderTask) {\n        this.textLayerRenderTask.cancel();\n        this.textLayerRenderTask = null;\n      }\n\n      this.textDivs = [];\n      var textLayerFrag = document.createDocumentFragment();\n      this.textLayerRenderTask = PDFJS.renderTextLayer({\n        textContent: this.textContent,\n        container: textLayerFrag,\n        viewport: this.viewport,\n        textDivs: this.textDivs,\n        timeout: timeout\n      });\n      this.textLayerRenderTask.promise.then(function () {\n        this.textLayerDiv.appendChild(textLayerFrag);\n        this._finishRendering();\n        this.updateMatches();\n      }.bind(this), function (reason) {\n        // canceled or failed to render text layer -- skipping errors\n      });\n    },\n\n    setTextContent: function TextLayerBuilder_setTextContent(textContent) {\n      if (this.textLayerRenderTask) {\n        this.textLayerRenderTask.cancel();\n        this.textLayerRenderTask = null;\n      }\n      this.textContent = textContent;\n      this.divContentDone = true;\n    },\n\n    convertMatches: function TextLayerBuilder_convertMatches(matches) {\n      var i = 0;\n      var iIndex = 0;\n      var bidiTexts = this.textContent.items;\n      var end = bidiTexts.length - 1;\n      var queryLen = (this.findController === null ?\n                      0 : this.findController.state.query.length);\n      var ret = [];\n\n      for (var m = 0, len = matches.length; m < len; m++) {\n        // Calculate the start position.\n        var matchIdx = matches[m];\n\n        // Loop over the divIdxs.\n        while (i !== end && matchIdx >= (iIndex + bidiTexts[i].str.length)) {\n          iIndex += bidiTexts[i].str.length;\n          i++;\n        }\n\n        if (i === bidiTexts.length) {\n          console.error('Could not find a matching mapping');\n        }\n\n        var match = {\n          begin: {\n            divIdx: i,\n            offset: matchIdx - iIndex\n          }\n        };\n\n        // Calculate the end position.\n        matchIdx += queryLen;\n\n        // Somewhat the same array as above, but use > instead of >= to get\n        // the end position right.\n        while (i !== end && matchIdx > (iIndex + bidiTexts[i].str.length)) {\n          iIndex += bidiTexts[i].str.length;\n          i++;\n        }\n\n        match.end = {\n          divIdx: i,\n          offset: matchIdx - iIndex\n        };\n        ret.push(match);\n      }\n\n      return ret;\n    },\n\n    renderMatches: function TextLayerBuilder_renderMatches(matches) {\n      // Early exit if there is nothing to render.\n      if (matches.length === 0) {\n        return;\n      }\n\n      var bidiTexts = this.textContent.items;\n      var textDivs = this.textDivs;\n      var prevEnd = null;\n      var pageIdx = this.pageIdx;\n      var isSelectedPage = (this.findController === null ?\n        false : (pageIdx === this.findController.selected.pageIdx));\n      var selectedMatchIdx = (this.findController === null ?\n                              -1 : this.findController.selected.matchIdx);\n      var highlightAll = (this.findController === null ?\n                          false : this.findController.state.highlightAll);\n      var infinity = {\n        divIdx: -1,\n        offset: undefined\n      };\n\n      function beginText(begin, className) {\n        var divIdx = begin.divIdx;\n        textDivs[divIdx].textContent = '';\n        appendTextToDiv(divIdx, 0, begin.offset, className);\n      }\n\n      function appendTextToDiv(divIdx, fromOffset, toOffset, className) {\n        var div = textDivs[divIdx];\n        var content = bidiTexts[divIdx].str.substring(fromOffset, toOffset);\n        var node = document.createTextNode(content);\n        if (className) {\n          var span = document.createElement('span');\n          span.className = className;\n          span.appendChild(node);\n          div.appendChild(span);\n          return;\n        }\n        div.appendChild(node);\n      }\n\n      var i0 = selectedMatchIdx, i1 = i0 + 1;\n      if (highlightAll) {\n        i0 = 0;\n        i1 = matches.length;\n      } else if (!isSelectedPage) {\n        // Not highlighting all and this isn't the selected page, so do nothing.\n        return;\n      }\n\n      for (var i = i0; i < i1; i++) {\n        var match = matches[i];\n        var begin = match.begin;\n        var end = match.end;\n        var isSelected = (isSelectedPage && i === selectedMatchIdx);\n        var highlightSuffix = (isSelected ? ' selected' : '');\n\n        if (this.findController) {\n          this.findController.updateMatchPosition(pageIdx, i, textDivs,\n                                                  begin.divIdx, end.divIdx);\n        }\n\n        // Match inside new div.\n        if (!prevEnd || begin.divIdx !== prevEnd.divIdx) {\n          // If there was a previous div, then add the text at the end.\n          if (prevEnd !== null) {\n            appendTextToDiv(prevEnd.divIdx, prevEnd.offset, infinity.offset);\n          }\n          // Clear the divs and set the content until the starting point.\n          beginText(begin);\n        } else {\n          appendTextToDiv(prevEnd.divIdx, prevEnd.offset, begin.offset);\n        }\n\n        if (begin.divIdx === end.divIdx) {\n          appendTextToDiv(begin.divIdx, begin.offset, end.offset,\n                          'highlight' + highlightSuffix);\n        } else {\n          appendTextToDiv(begin.divIdx, begin.offset, infinity.offset,\n                          'highlight begin' + highlightSuffix);\n          for (var n0 = begin.divIdx + 1, n1 = end.divIdx; n0 < n1; n0++) {\n            textDivs[n0].className = 'highlight middle' + highlightSuffix;\n          }\n          beginText(end, 'highlight end' + highlightSuffix);\n        }\n        prevEnd = end;\n      }\n\n      if (prevEnd) {\n        appendTextToDiv(prevEnd.divIdx, prevEnd.offset, infinity.offset);\n      }\n    },\n\n    updateMatches: function TextLayerBuilder_updateMatches() {\n      // Only show matches when all rendering is done.\n      if (!this.renderingDone) {\n        return;\n      }\n\n      // Clear all matches.\n      var matches = this.matches;\n      var textDivs = this.textDivs;\n      var bidiTexts = this.textContent.items;\n      var clearedUntilDivIdx = -1;\n\n      // Clear all current matches.\n      for (var i = 0, len = matches.length; i < len; i++) {\n        var match = matches[i];\n        var begin = Math.max(clearedUntilDivIdx, match.begin.divIdx);\n        for (var n = begin, end = match.end.divIdx; n <= end; n++) {\n          var div = textDivs[n];\n          div.textContent = bidiTexts[n].str;\n          div.className = '';\n        }\n        clearedUntilDivIdx = match.end.divIdx + 1;\n      }\n\n      if (this.findController === null || !this.findController.active) {\n        return;\n      }\n\n      // Convert the matches on the page controller into the match format\n      // used for the textLayer.\n      this.matches = this.convertMatches(this.findController === null ?\n        [] : (this.findController.pageMatches[this.pageIdx] || []));\n      this.renderMatches(this.matches);\n    },\n\n    /**\n     * Fixes text selection: adds additional div where mouse was clicked.\n     * This reduces flickering of the content if mouse slowly dragged down/up.\n     * @private\n     */\n    _bindMouse: function TextLayerBuilder_bindMouse() {\n      var div = this.textLayerDiv;\n      div.addEventListener('mousedown', function (e) {\n        var end = div.querySelector('.endOfContent');\n        if (!end) {\n          return;\n        }\n//#if !(MOZCENTRAL || FIREFOX)\n        // On non-Firefox browsers, the selection will feel better if the height\n        // of the endOfContent div will be adjusted to start at mouse click\n        // location -- this will avoid flickering when selections moves up.\n        // However it does not work when selection started on empty space.\n        var adjustTop = e.target !== div;\n//#if GENERIC\n        adjustTop = adjustTop && window.getComputedStyle(end).\n          getPropertyValue('-moz-user-select') !== 'none';\n//#endif\n        if (adjustTop) {\n          var divBounds = div.getBoundingClientRect();\n          var r = Math.max(0, (e.pageY - divBounds.top) / divBounds.height);\n          end.style.top = (r * 100).toFixed(2) + '%';\n        }\n//#endif\n        end.classList.add('active');\n      });\n      div.addEventListener('mouseup', function (e) {\n        var end = div.querySelector('.endOfContent');\n        if (!end) {\n          return;\n        }\n//#if !(MOZCENTRAL || FIREFOX)\n        end.style.top = '';\n//#endif\n        end.classList.remove('active');\n      });\n    },\n  };\n  return TextLayerBuilder;\n})();\n\n/**\n * @constructor\n * @implements IPDFTextLayerFactory\n */\nfunction DefaultTextLayerFactory() {}\nDefaultTextLayerFactory.prototype = {\n  /**\n   * @param {HTMLDivElement} textLayerDiv\n   * @param {number} pageIndex\n   * @param {PageViewport} viewport\n   * @returns {TextLayerBuilder}\n   */\n  createTextLayerBuilder: function (textLayerDiv, pageIndex, viewport) {\n    return new TextLayerBuilder({\n      textLayerDiv: textLayerDiv,\n      pageIndex: pageIndex,\n      viewport: viewport\n    });\n  }\n};\n\nmodule.exports = {\n  TextLayerBuilder: TextLayerBuilder\n};"]}